name: Update GitHub Stats
on:
  schedule:
    - cron: "0 23 * * *" # Tous les jours à 23:00 UTC (00:00 en France hiver, 01:00 en été)
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  github-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 10
    steps:
      # --- ÉTAPE 0 : CHECKOUT (NÉCESSAIRE POUR LE COMMIT) ---
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- ÉTAPE 1 : CHIFFRES CLÉS (COMMITS, PR, REPOS) ---
      - name: Statistiques de Contributions
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GH_STATS_TOKEN }}
          user: ${{ github.repository_owner }}
          template: classic
          # header : ton nom/avatar
          # repositories : le détail Public/Privé
          # metadata : les chiffres bruts (Commits, PR, Issues)
          base: header, repositories, metadata
          config_display: large
          
          # --- REPO LE PLUS ACTIF (FAITS UNIQUEMENT) ---
          plugin_habits: yes
          plugin_habits_from: 1000       # Augmente la précision (max 1000)
          plugin_habits_days: 30         # Analyse sur 30 jours pour avoir plus de données
          plugin_habits_facts: yes
          plugin_habits_charts: no # Supprime les graphiques d'habitudes
          
          # --- LIGNES DE CODE ---
          plugin_lines: yes
          
          config_timezone: Europe/Paris
          output_action: none
          filename: assets/github-stats.svg

      # --- ÉTAPE 2 : LANGAGES (AVEC HTML/CSS) ---
      - name: Langages les plus utilisés
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GH_STATS_TOKEN }}
          user: ${{ github.repository_owner }}
          base: "" 
          config_display: large
          plugin_languages: yes
          plugin_languages_details: percentage
          plugin_languages_sections: most-used
          plugin_languages_indepth: yes # Analyse le code réel pour plus de précision
          plugin_languages_limit: 8     # Garde le graphique lisible
          plugin_languages_ignored: "" # Force l'inclusion de tous les langages (HTML/CSS inclus)
          output_action: none
          filename: assets/top-langs.svg

      # --- ÉTAPE 3 : COMMIT GROUPÉ ---
      - name: Commit & Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update github metrics"
          file_pattern: assets/*.svg
